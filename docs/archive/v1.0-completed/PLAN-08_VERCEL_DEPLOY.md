# PLAN-08_VERCEL_DEPLOY (Vercel 部署适配)

**目标**: 让 `GridWorkflow` 能在 Vercel 环境稳定部署并可运行。

## 范围
**包含**:
- 前端静态部署 (Vite/React)
- 后端 API 以 Serverless Functions 方式部署

**不包含**:
- 长时间后台任务 (需外部队列或第三方任务系统)

## 关键约束
- **函数超时**：Vercel Serverless 适合短请求，不适合长时生成任务。
- **文件系统**：临时文件可用，但不可作为长期存储。
- **包体积**：依赖越小越好，避免超限。

## 必要适配
1. **异步任务化**: 视频生成必须立即返回 `task_id`，前端轮询 `/video/status/{task_id}`。
2. **媒体存储外置**: 图片/视频必须落 COS，前端只拿 URL。
3. **环境变量**: 所有密钥通过 Vercel Env 注入。
4. **请求大小控制**: base64 限制 < 2MB；大文件走 COS 上传后传 URL。

## 验收
- Vercel 构建通过
- 前端可访问并调用后端 API
- 视频生成任务不会因超时失败

## PDCA 钩子
- **Plan**: 明确 Vercel 的“短请求”边界，冻结“视频生成必须异步 + 外部状态”的约束。
- **Do**: 完成前端静态部署与后端函数化部署的最小可运行形态，密钥全部走环境变量。
- **Check**: 验证构建产物可访问；验证视频生成请求不会被函数超时截断；验证请求体大小门禁生效。
- **Act**: 若 Vercel 约束无法满足稳定性，先调整部署架构（例如后端迁移到更适合长任务的平台），再继续扩功能。

## Agent 上下文注入包
- **负责人团队**: Joint（Codex + Gemini 串行收敛）
- **本阶段目标**: 让项目在 Vercel 构建通过并可运行最小闭环，验证异步任务与外部状态策略。
- **输入**: 本文档、WP-GW-03/04/05 的最小闭环产物、Vercel 环境变量清单。
- **输出**: 可部署配置与构建通过的产物、部署验收记录、超时/请求体门禁验证说明。
- **冻结约束**:
  - 长任务必须异步化并返回 `task_id`
  - 媒体必须外置存储（COS）
  - 所有密钥只通过环境变量注入
- **禁止事项（高风险）**:
  - 在 Serverless 中执行长耗时生成并等待完成
  - 将大文件/大 base64 直接塞进请求体
- **验收 Checklist**:
  - Vercel 构建通过
  - 前端可访问并调用后端 API
  - 视频生成返回 `task_id` 且轮询可用
- **回滚策略**:
  - 若 Serverless 约束无法满足，后端迁移到更适合长任务的平台，前端保持不变。
