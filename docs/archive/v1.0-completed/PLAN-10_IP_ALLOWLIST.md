# PLAN-10_IP_ALLOWLIST (企业内网弱鉴权)

**目标**: 对指定 IP 访问提供“弱鉴权”模式，降低企业内网使用成本。

## 范围
**包含**:
- IP 白名单解析 (支持 CIDR)
- 弱鉴权策略 (仅对非敏感接口)

**不包含**:
- 完全免鉴权
- 代替 Supabase Auth

## 关键实现点
- 仅信任可信代理注入的 `X-Forwarded-For`
- 生产环境必须配置 `IP_ALLOWLIST`
- 默认白名单预设：`97.64.29.114`
- 对生成类接口仍要求 JWT 校验

## Agent 风险点
- 不要把 IP 白名单当成管理员权限
- 不要默认开启弱鉴权

## 验收
- 白名单 IP 可访问只读接口
- 生成接口仍需登录

## PDCA 钩子
- **Plan**: 冻结“弱鉴权仅覆盖非敏感只读接口”的边界，生成类接口永远需要强鉴权。
- **Do**: 实现 CIDR 白名单解析与可信代理校验，默认不开启弱鉴权。
- **Check**: 验证白名单 IP 仅能访问允许的只读接口；验证生成接口在白名单 IP 下仍会被鉴权拦截。
- **Act**: 若出现误放行风险，优先收紧策略与增加审计日志，再考虑扩展可放行接口范围。

## Agent 上下文注入包
- **负责人团队**: Codex (后端)
- **本阶段目标**: 实现 IP 白名单弱鉴权（仅只读接口），并确保生成接口仍需强鉴权。
- **输入**: 本文档、`PRECHECK-SEC_ARCH_AGENT.md`、部署环境的可信代理配置。
- **输出**: CIDR 解析、可信代理校验、弱鉴权开关与只读接口清单。
- **冻结约束**:
  - 默认不开启，必须显式配置才启用
  - 生成类接口仍需 JWT 校验
- **禁止事项（高风险）**:
  - 将 IP 白名单当成管理员权限
  - 信任未校验的 `X-Forwarded-For`
- **验收 Checklist**:
  - 白名单 IP 可访问只读接口
  - 生成接口仍需登录
  - 非白名单 IP 无法绕过鉴权
- **回滚策略**:
  - 发现误放行立即关闭开关并回滚到纯 JWT 鉴权。
