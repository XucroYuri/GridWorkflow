# PRECHECK-SEC_ARCH_AGENT (重构前检查清单)

**目标**: 在 `GRIDWORKFLOW_ROOT` 开始代码迁移前，从安全性、架构稳定性、Agent 友好度三方面排除高风险项。

## 0. 结论门禁 (必须满足)
- 新仓库目录仅包含新项目文件，不允许混入旧仓库代码。
- 关键配置项全部通过环境变量提供，不写死在代码中。
- 统一 API 响应结构 `{ ok, data, error }` 已冻结。
- PDCA 治理文档已存在，且本次变更会同步更新对应模块的验收与风险项。

---

## 1. 安全性检查 (Security)

**必须排除**
- 禁止将 `AI_GATEWAY_API_KEY`、`COS_SECRET_KEY`、`COS_SECRET_ID` 输出到日志。
- 禁止在前端保存任何后端密钥或 COS 凭证。
- 禁止后端直接信任前端传入的 URL 并进行下载（SSRF 风险）。
- 禁止在前端暴露完整 Prompt 模板或系统提示词。
- 禁止在前端保存 Supabase Service Role Key。
- 禁止用 `X-Forwarded-For` 直接做 IP 放行（必须验证可信代理）。
- 禁止将上游返回的完整错误体原样透传给前端（可能包含敏感信息或内部细节）。
- 禁止对用户上传文件做“仅凭扩展名/Content-Type”信任（必须做大小与类型校验，避免解析炸弹与畸形文件）。
- 禁止无速率限制地暴露生成接口（避免被刷爆导致成本与可用性风险）。

**必须确认**
- 后端日志脱敏：只保留 `request_id`、`model`、`step`、`latency_ms`。
- `x-user-gemini-key` 为可选头，优先使用但不记录。
- CORS 白名单可配置（非 `*`）。
- 后端加密存储敏感配置（环境变量 + 进程内使用，不落盘）。
- 媒体 URL 使用签名或限时访问（COS Signed URL）。
- Supabase JWT 必须在后端校验，禁止只靠前端判断登录态。
- IP 白名单仅用于“弱化鉴权”，不可完全绕过关键操作。
- 上传类与 base64 输入有硬门禁（尺寸上限、数量上限、超限返回 `BAD_REQUEST`）。
- 任务查询接口对 `task_id` 做格式与长度校验，避免枚举与日志注入。
- 认证令牌不落日志；前端如需缓存令牌，明确风险与退出机制。

**建议**
- 为 `images` 列表限制大小与数量（避免大流量与误提交）。
- 统一超时（文本 10s / 图片 30s / 视频 180s）与错误码映射。
- 对关键接口增加速率限制（Rate Limit）。
- 对 Prompt 注入风险做最小防护：系统模板与用户输入分区拼接，用户输入不允许覆盖系统规则。
- 对媒体 URL 展示做签名参数保护（避免在 UI、日志与分享链接中泄露签名查询参数）。

---

## 2. 架构稳定性检查 (Stability)

**必须排除**
- 业务层直接调用外部 API URL。
- 前端直连 `https://ai.t8star.cn/v1`（必须走后端代理）。
- 多层重复拼接 Prompt（前后端只能保留一份模板来源）。

**必须确认**
- Video Provider 通过注册表选择，默认仅允许 `t8star`。
- 统一 API Client，前端所有请求只走 `apiClient.ts`。
- `video/status` 依赖 `Sora2查询任务.md` 的 `/v2/videos/generations/{task_id}`。
- 异步任务持久化（内存或轻量存储），避免重启丢失状态。

**建议**
- 失败重试策略：文本 1 次，图片 0 次，视频 0 次。
- 任务状态轮询间隔 >= 3s，避免频繁打爆网关。
- 并发控制：按用户/租户限制并发任务数。

---

## 3. Agent 友好检查 (Agent-Safe)

**必须排除**
- Agent 在未声明的情况下修改 `api_service.py` 的 multipart 结构。
- Agent 直接添加新的服务目录或改动目录结构。
- Agent 批量修改 Prompt 模板为 JSON/结构化输出。
- Agent 绕过统一响应结构 `{ ok, data, error }`，直接返回 raw data。
- Agent 在前端直接拼接外部 API（含 `ai.t8star.cn`）或将密钥引入前端。

**必须确认**
- 每个模块都有独立计划文档（见 `docs/`）。
- 任务拆分粒度 <= 1 天/模块，禁止跨模块混改。
- 对关键冻结项有醒目标识（例如在关键文件开头明确“不可自动重构/不可改动契约”）。
- Prompt 仅在后端拼接，前端只接收可展示摘要。
- 已对照 [PDCA-00_PROJECT_GOVERNANCE.md](PDCA-00_PROJECT_GOVERNANCE.md) 明确本次变更的 Plan/Check/Act。

### 3.1 Vibe Coding 模式协作规范（必须）

- **单模块聚焦**：一次只做一个 `PLAN-*` 的范围内变更，禁止跨模块混改。
- **文档与实现同步**：任何接口/流程/约束变更，必须同步更新对应文档的输入输出、验收标准与风险点。
- **最小可验收**：至少提供 1 条成功路径与 1 条失败路径的检查方式（可复现）。
- **变更可回退**：每个模块必须说明失败时如何回退到上一个可用状态（配置切换/保留旧接口/禁用新入口）。

---

## 4. 迁移动作清单 (执行前)

1. 核对目标目录 `GRIDWORKFLOW_ROOT` 仅作为新仓库根目录（剥离前可为暂存目录，剥离后为独立目录）。
2. 确认 `Sora2查询任务.md` 完整且可用。
3. 生成 `.env.example`，仅包含必需键。
4. 前端/后端端口与 API Base 明确并记录。
5. 确认 `PDCA-00_PROJECT_GOVERNANCE` 已被执行并纳入每个模块的验收流程。

---

## 5. 通过/阻断判定

**通过**: 所有 “必须排除 / 必须确认” 项已达成。  
**阻断**: 任一项未满足，暂停迁移或要求补充文档/实现。
