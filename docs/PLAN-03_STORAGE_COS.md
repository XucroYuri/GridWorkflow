# PLAN-03_STORAGE_COS (腾讯云对象存储)

**目标**: 将图片/视频统一上传至腾讯云 COS，前端只持有 URL，避免本地存储与浏览器负载。

## 范围
**包含**:
- `backend/app/storage/cos_client.py`
- 上传图片/视频并返回 URL
- 可选签名 URL

**不包含**:
- CDN 优化
- 复杂权限体系

## 配置项
- `COS_SECRET_ID`
- `COS_SECRET_KEY`
- `COS_BUCKET`
- `COS_REGION`

## 关键实现点
- 上传后返回可直接访问 URL
- 失败时回退为原始 URL (如仍可用)
- 大文件分片上传预留接口

## Agent 风险点
- 不要在前端直接上传密钥
- 不要把 COS 逻辑耦合进业务服务

## 验收
- 图片上传成功返回 URL
- 视频上传成功返回 URL

## PDCA 钩子
- **Plan**: 明确存储的最小契约（输入文件、输出 URL、可选签名 URL、失败回退规则）。
- **Do**: 只实现上传与返回 URL，不把 COS 细节耦合进业务服务层。
- **Check**: 验证图片/视频两类对象都能访问；验证失败路径不会泄露密钥或签名参数。
- **Act**: 若出现大文件/超时问题，先在存储层增加分片/异步能力，再调整上层业务与 UI。

## Agent 上下文注入包
- **负责人团队**: Codex (后端)
- **本阶段目标**: 实现媒体统一出站（COS）并保证密钥与签名安全。
- **输入**: 本文档、`PRECHECK-SEC_ARCH_AGENT.md`、对象存储配置项说明。
- **输出**: COS 客户端与上传实现、URL/签名策略、失败回退策略说明。
- **冻结约束**:
  - COS 密钥仅后端使用，禁止出现在前端与日志中
  - 返回 URL 不泄露可长期有效的敏感签名参数
- **禁止事项（高风险）**:
  - 把 COS 逻辑耦合进业务服务层
  - 透传上游 URL 的签名参数到前端日志或 UI
- **验收 Checklist**:
  - 图片上传成功返回 URL
  - 视频上传成功返回 URL
  - 失败路径不泄露密钥或签名参数
- **回滚策略**:
  - 若 COS 集成不稳定，短期以占位实现保持接口不变，后续在存储层修复后再替换。
