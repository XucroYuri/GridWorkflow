# GridWorkflow 架构图与依赖关系

**生成日期**: 2026-01-07  
**文档版本**: v1.0  

---

## 1. 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户浏览器                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     React 19 + TypeScript                           │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐    │   │
│  │  │ 登录页面 │  │ 首页     │  │ Video    │  │ GridWorkflow     │    │   │
│  │  │ Login   │  │ Home     │  │ Studio   │  │ (核心工作流)      │    │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘    │   │
│  │       │              │              │              │                │   │
│  │       └──────────────┴──────────────┴──────────────┘                │   │
│  │                              │                                       │   │
│  │                    ┌─────────▼─────────┐                            │   │
│  │                    │   apiClient.ts    │                            │   │
│  │                    │   (Axios + 拦截器) │                            │   │
│  │                    └─────────┬─────────┘                            │   │
│  └──────────────────────────────┼──────────────────────────────────────┘   │
└─────────────────────────────────┼───────────────────────────────────────────┘
                                  │ HTTPS
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Vercel Edge Network                               │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                     vercel.json 路由规则                            │    │
│  │  /api/v1/*  ────────────►  api/index.py (Serverless Python)        │    │
│  │  /media/*   ────────────►  api/index.py                            │    │
│  │  /*         ────────────►  frontend/dist/index.html (SPA)          │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          FastAPI Backend                                    │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                         main.py                                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐    │    │
│  │  │ CORS       │  │ Exception  │  │ Request Context         │    │    │
│  │  │ Middleware │  │ Handlers   │  │ (request_id, logging)   │    │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                  │                                          │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        API Router                                   │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │    │
│  │  │ health  │  │ ai      │  │ video   │  │ media   │  │workflow │  │    │
│  │  │ .py     │  │ .py     │  │ .py     │  │ .py     │  │ .py     │  │    │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                  │                                          │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                       Services Layer                                │    │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐  │    │
│  │  │ ai_service    │  │ video_service │  │ workflow_service      │  │    │
│  │  │ (文本/图像)    │  │ (视频生成)    │  │ (工作流辅助)          │  │    │
│  │  └───────────────┘  └───────────────┘  └───────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                  │                                          │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        Core Layer                                   │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────────┐  │    │
│  │  │ config  │  │ auth    │  │ logger  │  │ prompts             │  │    │
│  │  │ .py     │  │ .py     │  │ .py     │  │ .py                 │  │    │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                  │                                          │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                       Storage Layer                                 │    │
│  │  ┌─────────────────────────────────────────────────────────────┐  │    │
│  │  │                    cos_client.py                             │  │    │
│  │  │                    (腾讯云 COS 适配器)                        │  │    │
│  │  └─────────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
        │                         │                         │
        │ JWT 验证                 │ API 调用                 │ 文件上传
        ▼                         ▼                         ▼
┌───────────────┐        ┌───────────────┐        ┌───────────────┐
│   Supabase    │        │  T8Star AI    │        │  腾讯云 COS   │
│   Auth        │        │  Gateway      │        │  存储         │
│               │        │               │        │               │
│ - 用户认证    │        │ - Gemini      │        │ - 图片存储    │
│ - JWT 签发    │        │ - Sora 2      │        │ - 视频存储    │
│ - 会话管理    │        │ - 图像生成    │        │ - 签名 URL    │
└───────────────┘        └───────────────┘        └───────────────┘
```

---

## 2. 工作流数据流图

```
用户输入                    Step 1                      Step 2
┌──────────┐             ┌──────────┐               ┌──────────┐
│ 剧情片段 │             │ 概念图   │               │ 分镜规划 │
│ 风格设定 │─────────────►│ 生成    │───────────────►│ (LLM)   │
│ 视觉锚点 │             │ (图像)   │               │          │
└──────────┘             └──────────┘               └──────────┘
                              │                          │
                              │ concept_image_url        │ storyboard_prompt
                              ▼                          ▼
                         ┌──────────┐               ┌──────────┐
                         │ 参考图像 │               │ Prompt   │
                         │ 保留     │               │ 编辑     │
                         └──────────┘               └──────────┘
                                                         │
                    Step 3                               │
                    ┌──────────┐                         │
                    │ 九宫格   │◄────────────────────────┘
                    │ 生成    │
                    │ (图像)   │
                    └──────────┘
                         │
                         │ grid_image_url
                         ▼
                    ┌──────────┐
                    │ 视觉确认 │◄──────── 支持 Reroll
                    └──────────┘
                         │
                    Step 4
                    ┌──────────┐
                    │ 视频     │
                    │ Prompt  │
                    │ 生成    │
                    └──────────┘
                         │
                         │ video_prompt (可编辑)
                         ▼
                    Step 5
                    ┌──────────┐
                    │ Sora 2   │
                    │ 视频生成 │
                    └──────────┘
                         │
                         │ task_id
                         ▼
                    ┌──────────┐
                    │ 轮询状态 │◄──────── 3秒间隔
                    │ 直到完成 │
                    └──────────┘
                         │
                         │ video_url
                         ▼
                    ┌──────────┐
                    │ 视频预览 │
                    │ 下载     │
                    └──────────┘
```

---

## 3. API 端点映射

### 3.1 工作流端点 (`/api/v1/`)

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `/concept` | POST | Step 1: 概念图生成 | JWT |
| `/storyboard/plan` | POST | Step 2: 分镜规划 | JWT |
| `/storyboard/generate` | POST | Step 3: 九宫格生成 | JWT |
| `/video/prompt` | POST | Step 4: 视频 Prompt | JWT |

### 3.2 视频端点 (`/api/v1/video/`)

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `/generate` | POST | Step 5: 提交视频任务 | JWT |
| `/status/{task_id}` | GET | 查询任务状态 | JWT/IP白名单 |

### 3.3 AI 端点 (`/api/v1/ai/`)

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `/analyze` | POST | 文本分析 (LLM) | JWT |
| `/generate-image` | POST | 图像生成 | JWT |

### 3.4 媒体端点

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `/media/upload` | POST | 上传图片/视频到 COS | JWT |

### 3.5 健康检查

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `/health` | GET | 服务健康检查 | 无 |

---

## 4. 前端组件依赖树

```
App.tsx
├── UIConfigProvider
│   └── ToastProvider
│       └── LightboxProvider
│           └── AuthProvider
│               └── BrowserRouter
│                   └── ProtectedRoute
│                       └── LayoutWrapper
│                           ├── MainLayout
│                           │   ├── Header (内联)
│                           │   ├── SidebarLeft
│                           │   ├── SidebarRight
│                           │   └── MobileNav
│                           └── Routes
│                               ├── Home
│                               └── VideoStudio
│                                   ├── GridWorkflow ⭐ (核心)
│                                   ├── TaskList
│                                   └── VideoPreview
└── ToastContainer
```

### 组件职责

| 组件 | 职责 | 状态管理 |
|------|------|----------|
| `AuthProvider` | Supabase 会话管理 | Context |
| `ToastProvider` | 全局通知 | Context |
| `LightboxProvider` | 图片预览 | Context |
| `UIConfigProvider` | UI 配置 | Context |
| `GridWorkflow` | 5 步工作流 | Local State |
| `TaskList` | 任务列表展示 | Props |
| `VideoPreview` | 视频播放 | Props |

---

## 5. 后端模块依赖图

```
main.py
│
├── api/__init__.py
│   ├── routes/health.py
│   │   └── core/config.py
│   │   └── schemas/response.py
│   │
│   ├── routes/ai.py
│   │   ├── core/auth.py
│   │   ├── core/config.py
│   │   ├── schemas/ai.py
│   │   ├── schemas/response.py
│   │   └── services/ai_service.py
│   │       └── core/config.py
│   │
│   ├── routes/video.py
│   │   ├── core/auth.py
│   │   ├── core/config.py
│   │   ├── schemas/video.py
│   │   ├── schemas/response.py
│   │   └── services/video_service.py
│   │       └── core/config.py
│   │
│   ├── routes/workflow.py
│   │   ├── core/auth.py
│   │   ├── core/config.py
│   │   ├── core/prompts.py
│   │   │   └── schemas/workflow.py
│   │   ├── schemas/ai.py
│   │   ├── schemas/workflow.py
│   │   ├── schemas/response.py
│   │   ├── services/ai_service.py
│   │   └── services/workflow_service.py
│   │       └── schemas/workflow.py
│   │
│   └── routes/media.py
│       ├── core/auth.py
│       ├── core/config.py
│       ├── schemas/response.py
│       └── storage/cos_client.py
│           └── core/config.py
│
├── core/auth.py
│   └── core/config.py
│
├── core/config.py (根模块)
│
└── core/logger.py
```

---

## 6. 外部服务依赖

### 6.1 运行时依赖

```
GridWorkflow
    │
    ├── Supabase Auth (必须)
    │   ├── 用户注册/登录
    │   └── JWT Token 签发
    │
    ├── T8Star AI Gateway (必须)
    │   ├── /v1/chat/completions (文本分析)
    │   ├── /v1/images/edits (图像生成)
    │   └── /v2/videos/generations (Sora 2)
    │
    └── 腾讯云 COS (可选)
        └── 媒体文件持久化
```

### 6.2 开发/构建依赖

```
后端 Python:
├── fastapi==0.110.1
├── uvicorn[standard]==0.29.0
├── httpx>=0.24.0
├── PyJWT==2.9.0
├── pydantic (内置于 fastapi)
├── cos-python-sdk-v5==1.9.32
└── python-multipart==0.0.9

前端 Node.js:
├── react@19.2.0
├── react-dom@19.2.0
├── react-router-dom@7.11.0
├── @supabase/supabase-js@2.90.0
├── axios@1.13.2
├── tailwindcss@3.4.19
├── vite@7.2.4
└── typescript@5.9.3
```

---

## 7. 部署架构

### 7.1 Vercel 部署

```
GitHub Repository
       │
       │ Push / PR Merge
       ▼
┌─────────────────────────────────────────────────────────────┐
│                     Vercel Build                            │
│  ┌─────────────────────┐  ┌────────────────────────────┐   │
│  │ @vercel/python      │  │ @vercel/static-build       │   │
│  │ api/index.py        │  │ frontend/ → dist/          │   │
│  │ 30s timeout         │  │ Vite build                 │   │
│  └─────────────────────┘  └────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
       │
       │ Deploy
       ▼
┌─────────────────────────────────────────────────────────────┐
│                   Vercel Edge Network                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ CDN         │  │ Serverless  │  │ Environment         │ │
│  │ Static      │  │ Functions   │  │ Variables           │ │
│  │ Assets      │  │ (Python)    │  │ (Secrets)           │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 环境变量配置

```bash
# Vercel Environment Variables

# 基础配置
APP_ENV=production
LOG_LEVEL=INFO
CORS_ALLOW_ORIGINS=https://your-domain.vercel.app

# AI 网关
AI_GATEWAY_BASE_URL=https://ai.t8star.cn/v1
AI_GATEWAY_API_KEY=sk-xxx

# Supabase 认证
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJxxx
SUPABASE_JWT_SECRET=xxx

# 腾讯云 COS (可选)
COS_SECRET_ID=AKIDxxx
COS_SECRET_KEY=xxx
COS_BUCKET=bucket-xxx
COS_REGION=ap-guangzhou

# IP 白名单 (可选)
IP_ALLOWLIST_ENABLED=false
IP_ALLOWLIST=x.x.x.x
```

---

## 8. 安全边界图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           公网 (不可信)                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         用户请求                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                            ┌────────▼────────┐
                            │  Vercel WAF     │
                            │  (DDoS 防护)    │
                            └────────┬────────┘
                                     │
┌────────────────────────────────────▼────────────────────────────────────┐
│                              信任边界 1                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      FastAPI 应用                               │   │
│  │  ┌─────────┐  ┌─────────────────────────────────────────────┐  │   │
│  │  │ CORS    │  │              认证层                         │  │   │
│  │  │ 检查    │  │  ┌─────────────┐  ┌─────────────────────┐  │  │   │
│  │  │         │  │  │ JWT 验证   │  │ IP 白名单           │  │  │   │
│  │  │         │  │  │ (Supabase) │  │ (可选)              │  │  │   │
│  │  └─────────┘  │  └─────────────┘  └─────────────────────┘  │  │   │
│  │               └─────────────────────────────────────────────┘  │   │
│  │                              │                                  │   │
│  │  ┌───────────────────────────▼───────────────────────────────┐ │   │
│  │  │                     输入验证层                             │ │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │ │   │
│  │  │  │ Pydantic    │  │ 文件类型    │  │ 大小限制        │   │ │   │
│  │  │  │ Schema      │  │ 验证        │  │                 │   │ │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────────┘   │ │   │
│  │  └───────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
┌────────────────────────────────────▼────────────────────────────────────┐
│                              信任边界 2                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      外部服务调用                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │   │
│  │  │ Supabase    │  │ T8Star AI   │  │ 腾讯云 COS              │ │   │
│  │  │ (认证)      │  │ (AI 服务)   │  │ (存储)                  │ │   │
│  │  │             │  │             │  │                         │ │   │
│  │  │ TLS 1.3     │  │ TLS 1.3    │  │ TLS 1.3 + 签名         │ │   │
│  │  │ API Key     │  │ Bearer     │  │ SecretId/SecretKey      │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

**文档版本**: v1.0  
**最后更新**: 2026-01-07

